```sql
CREATE TABLE IF NOT EXISTS users (
  username TEXT PRIMARY KEY,
  password TEXT NOT NULL,
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE IF NOT EXISTS play_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  key TEXT NOT NULL,
  title TEXT NOT NULL,
  source_name TEXT NOT NULL,
  cover TEXT NOT NULL,
  year TEXT NOT NULL,
  index_episode INTEGER NOT NULL,
  total_episodes INTEGER NOT NULL,
  play_time INTEGER NOT NULL,
  total_time INTEGER NOT NULL,
  save_time INTEGER NOT NULL,
  search_title TEXT,
  douban_id INTEGER,
  UNIQUE(username, key)
);

CREATE TABLE IF NOT EXISTS favorites (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  key TEXT NOT NULL,
  title TEXT NOT NULL,
  source_name TEXT NOT NULL,
  cover TEXT NOT NULL,
  year TEXT NOT NULL,
  total_episodes INTEGER NOT NULL,
  save_time INTEGER NOT NULL,
  UNIQUE(username, key)
);

CREATE TABLE IF NOT EXISTS search_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  keyword TEXT NOT NULL,
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  UNIQUE(username, keyword)
);

CREATE TABLE IF NOT EXISTS admin_config (
  id INTEGER PRIMARY KEY DEFAULT 1,
  config TEXT NOT NULL,
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE IF NOT EXISTS skip_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  source TEXT NOT NULL,
  id_video TEXT NOT NULL,
  enable INTEGER NOT NULL DEFAULT 0,
  intro_time INTEGER NOT NULL DEFAULT 0,
  outro_time INTEGER NOT NULL DEFAULT 0,
  UNIQUE(username, source, id_video)
);

-- 基本索引
CREATE INDEX IF NOT EXISTS idx_play_records_username ON play_records(username);
CREATE INDEX IF NOT EXISTS idx_favorites_username ON favorites(username);
CREATE INDEX IF NOT EXISTS idx_search_history_username ON search_history(username);

-- 复合索引优化查询性能
-- 播放记录：用户名+键值的复合索引，用于快速查找特定记录
CREATE INDEX IF NOT EXISTS idx_play_records_username_key ON play_records(username, key);
-- 播放记录：用户名+保存时间的复合索引，用于按时间排序的查询
CREATE INDEX IF NOT EXISTS idx_play_records_username_save_time ON play_records(username, save_time DESC);

-- 收藏：用户名+键值的复合索引，用于快速查找特定收藏
CREATE INDEX IF NOT EXISTS idx_favorites_username_key ON favorites(username, key);
-- 收藏：用户名+保存时间的复合索引，用于按时间排序的查询
CREATE INDEX IF NOT EXISTS idx_favorites_username_save_time ON favorites(username, save_time DESC);

-- 搜索历史：用户名+关键词的复合索引，用于快速查找/删除特定搜索记录
CREATE INDEX IF NOT EXISTS idx_search_history_username_keyword ON search_history(username, keyword);
-- 搜索历史：用户名+创建时间的复合索引，用于按时间排序的查询
CREATE INDEX IF NOT EXISTS idx_search_history_username_created_at ON search_history(username, created_at DESC);

-- 跳过片头片尾配置：用户名+源+视频ID的复合索引，用于快速查找特定配置
CREATE INDEX IF NOT EXISTS idx_skip_configs_username_source_id ON skip_configs(username, source, id_video);

-- 搜索历史清理查询的优化索引
CREATE INDEX IF NOT EXISTS idx_search_history_username_id_created_at ON search_history(username, id, created_at DESC);

-- 笔记表
CREATE TABLE IF NOT EXISTS notes (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL,
  title TEXT NOT NULL DEFAULT '',
  content TEXT NOT NULL DEFAULT '',
  tags TEXT NOT NULL DEFAULT '[]',
  pinned INTEGER NOT NULL DEFAULT 0,
  summary TEXT,
  is_archived INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  deleted_at INTEGER,
  UNIQUE (username, id)
);

CREATE INDEX IF NOT EXISTS idx_notes_username ON notes(username);
CREATE INDEX IF NOT EXISTS idx_notes_user_pin_updated ON notes(username, pinned DESC, updated_at DESC);

-- 导航分类表
CREATE TABLE IF NOT EXISTS nav_categories (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL,
  name TEXT NOT NULL,
  icon TEXT,
  description TEXT,
  color TEXT,
  parent_id TEXT,
  order_num INTEGER NOT NULL DEFAULT 0,
  sort_by TEXT DEFAULT 'order',
  is_collapsed INTEGER NOT NULL DEFAULT 0,
  is_visible INTEGER NOT NULL DEFAULT 1,
  is_private INTEGER NOT NULL DEFAULT 0,
  password TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  deleted_at INTEGER
);

-- 导航站点表
CREATE TABLE IF NOT EXISTS nav_sites (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL,
  category_id TEXT NOT NULL,
  name TEXT NOT NULL,
  url TEXT NOT NULL,
  backup_url TEXT,
  description TEXT,
  keywords TEXT,
  icon TEXT,
  icon_type TEXT DEFAULT 'auto',
  icon_bg_color TEXT,
  tags TEXT NOT NULL DEFAULT '[]',
  order_num INTEGER NOT NULL DEFAULT 0,
  is_pinned INTEGER NOT NULL DEFAULT 0,
  is_visible INTEGER NOT NULL DEFAULT 1,
  is_private INTEGER NOT NULL DEFAULT 0,
  password TEXT,
  target TEXT DEFAULT '_blank',
  status INTEGER NOT NULL DEFAULT 1,
  status_check_at INTEGER,
  visit_count INTEGER NOT NULL DEFAULT 0,
  last_visit_at INTEGER,
  rating INTEGER DEFAULT 0,
  notes TEXT,
  images TEXT NOT NULL DEFAULT '[]',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  deleted_at INTEGER
);

-- 导航分类表索引
CREATE INDEX IF NOT EXISTS idx_nav_categories_username ON nav_categories(username);
CREATE INDEX IF NOT EXISTS idx_nav_categories_user_order ON nav_categories(username, order_num);
CREATE INDEX IF NOT EXISTS idx_nav_categories_user_parent ON nav_categories(username, parent_id);
CREATE INDEX IF NOT EXISTS idx_nav_categories_user_visible ON nav_categories(username, is_visible, deleted_at);

-- 导航站点表索引
CREATE INDEX IF NOT EXISTS idx_nav_sites_username ON nav_sites(username);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_category ON nav_sites(username, category_id);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_order ON nav_sites(username, category_id, order_num);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_pinned ON nav_sites(username, is_pinned DESC, order_num);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_visit ON nav_sites(username, visit_count DESC);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_status ON nav_sites(username, status);
CREATE INDEX IF NOT EXISTS idx_nav_sites_user_visible ON nav_sites(username, is_visible, deleted_at);

-- 用户配置表（存储豆瓣cookie等敏感配置）
CREATE TABLE IF NOT EXISTS user_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  config_key TEXT NOT NULL,
  config_value TEXT NOT NULL,
  config_type TEXT DEFAULT 'string',
  description TEXT,
  is_encrypted INTEGER NOT NULL DEFAULT 0,
  is_sensitive INTEGER NOT NULL DEFAULT 1,
  expires_at INTEGER,
  metadata TEXT,
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  UNIQUE(username, config_key)
);

-- 用户配置表索引
CREATE INDEX IF NOT EXISTS idx_user_configs_username ON user_configs(username);
CREATE INDEX IF NOT EXISTS idx_user_configs_user_key ON user_configs(username, config_key);
CREATE INDEX IF NOT EXISTS idx_user_configs_expires ON user_configs(expires_at);
```

文档更新：
• D1 初始化.md - 添加了 nav_categories 和 nav_sites 表结构及索引

新增文件：
• src/lib/navs.types.ts - 扩展了类型定义，包含所有数据库字段
• src/app/api/navs/categories/route.ts - 分类 CRUD API
• src/app/api/navs/sites/route.ts - 站点 CRUD API
• src/app/api/navs/reorder/route.ts - 排序 API
• src/app/api/navs/visit/route.ts - 访问统计 API

修改文件：
• src/lib/navs.client.ts - 支持 localStorage 和 D1 双模式
• src/app/navs/NavsPageClient.tsx - 适配异步 API
• src/components/navs/NavsSidebar.tsx - 适配异步 API
• src/components/navs/NavsSiteList.tsx - 适配异步 API
• src/components/navs/NavsSiteModal.tsx - 适配异步 API
• src/components/navs/NavsCategoryModal.tsx - 适配异步 API

系统会根据 NEXT_PUBLIC_STORAGE_TYPE 环境变量自动选择存储方式：d1 使用 Cloudflare D1，其他值使用 localStorage。
